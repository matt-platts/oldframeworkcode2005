var CM={pid:0};CM.menu=new Class({Implements:Options,options:{mergeParent:true,links:[]},initialize:function(b,a){this.setOptions(a);this.target=$(b);this.target.CM={};this.bounds={};this.links=[];this.childs=[];this.build();this.target.CM.menu=this;this.bounds.unrender=this.unrender.bind(this);this.bounds.keydown=this.keydown.bind(this);this.target.addEvent("contextmenu",this.contextmenu.bind(this))},build:function(){this.div=new Element("div",{"class":"CM-menu"}).inject($(document.body));if(this.options.mergeParent){this.buildParent()}this.options.links.each(function(a){this.links.push(new CM.link(this,a))},this);this.links.each(function(a){a.div.inject(this.div)},this)},buildParent:function(){var a=this.target;while(a=a.getParent()){if(a.CM&&a.CM.menu){a.CM.menu.options.links.each(function(b){this.links.push(new CM.link(this,b))},this)}}},render:function(a){a.stop();this.show(a.page);this.links.each(function(b){b.render()},this);document.addEvent("click",this.bounds.unrender);document.addEvent("keydown",this.bounds.keydown)},unrender:function(){this.hide();this.links.each(function(a){a.unrender()},this);document.removeEvent("click",this.bounds.unrender);document.removeEvent("keydown",this.bounds.keydown)},contextmenu:function(a){document.fireEvent("click",this.bounds.unrender);this.render(a)},keydown:function(a){if(a.key=="esc"){this.unrender()}},show:function(a){this.div.setStyles({display:"block"});if(a.x+this.div.getCoordinates().width>$(document).getCoordinates().width){a.x-=this.div.getCoordinates().width}if(a.y+this.div.getCoordinates().height>$(document).getCoordinates().height){a.y-=this.div.getCoordinates().height}this.div.setStyles({top:a.y,left:a.x})},hide:function(){this.div.setStyles({display:"none"})}});CM.link=new Class({Implements:Options,options:{links:[],libelle:"",shortcut:"",icon:"",onclick:"",sep:false},initialize:function(b,a){CM.pid+=1;this.setOptions(a);this.pid="CM-link::"+CM.pid;this.CM={};this.CM.menu=b;this.CM.shortcut=new CM.shortcut(this,this.options.shortcut);this.build()},build:function(){if(this.div){return}var a=(this.options.sep)?" sep":"";this.div=new Element("div",{"class":"link"+a,text:this.options.libelle});if(this.options.icon){this.img=new Element("img",{"class":"icon",src:this.options.icon}).inject(this.div,"top")}else{this.img=new Element("div",{"class":"icon"}).inject(this.div,"top")}this.span=new Element("span",{"class":"note",text:this.CM.shortcut.getLibelle()}).inject(this.div);try{this.options.onclick.create();this.div.addEvent("click",this.options.onclick)}catch(b){this.div.addEvent("click",function(c){c.stop()})}this.div.CM={};this.div.CM.link=this;this.div.CM.menu=this.CM.menu;if(this.options.links.length){this.span.innerHTML="<img src=\"rc_menu/img/arrow_r.png\" border=\"0\" />";this.span.addClass("arrow");this.CM.menu.childs.push(new CM.child(this.div,{theme:this.CM.menu.options.theme,links:this.options.links}))}},render:function(){this.CM.shortcut.render()},unrender:function(){this.CM.shortcut.unrender();this.CM.menu.childs.each(function(a){a.unrender()},this)}});CM.child=new Class({Implements:Options,Extends:CM.menu,initialize:function(b,a){this.setOptions(a);this.target=$(b);this.bounds={};this.links=[];this.childs=[];this.build();this.bounds.unrender=this.unrender.bind(this);this.bounds.keydown=this.keydown.bind(this);this.target.addEvent("mouseenter",this.render.bind(this))},show:function(b){this.div.setStyles({display:"block"});var a=this.target.getCoordinates();a.x=a.left;a.x+=a.width;if(a.x+this.div.getCoordinates().width>$(document).getCoordinates().width){a.x=a.left;a.x-=a.width;a.x-=this.div.getStyle("borderLeft").toInt();a.x-=this.div.getStyle("borderRight").toInt()}a.y=a.top;a.y-=this.div.getStyle("borderTop").toInt();if(a.y+this.div.getCoordinates().height>$(document).getCoordinates().height){a.y=a.bottom;a.y-=this.div.getCoordinates().height;a.y+=this.div.getStyle("borderTop").toInt();a.y+=this.div.getStyle("borderBottom").toInt()}this.div.setStyles({top:a.y,left:a.x})},render:function(a){this.parent(a);this.target.CM.menu.links.each(function(b){if(this.target.CM.link.pid!=b.pid){b.div.addEvent("mouseenter",this.bounds.unrender)}},this)},unrender:function(){this.parent();this.target.CM.menu.links.each(function(a){if(this.target.CM.link.pid!=a.pid){a.div.removeEvent("mouseenter",this.bounds.unrender)}},this)}});CM.shortcut=new Class({Implements:Options,options:{control:false,shift:false,alt:false,key:"",},initialize:function(b,a){this.setOptions(a);this.CM={};this.CM.link=b;this.bounds={};this.bounds.keypress=this.keypress.bind(this)},getLibelle:function(){var a="";a+=(this.options.control)?"Ctrl + ":"";a+=(this.options.shift)?"Shift + ":"";a+=(this.options.alt)?"Alt + ":"";a+=this.options.key.capitalize();return a},render:function(){document.addEvent("keypress",this.bounds.keypress)},unrender:function(){document.removeEvent("keypress",this.bounds.keypress)},keypress:function(a){if(a.control==this.options.control&&a.shift==this.options.shift&&a.alt==this.options.alt&&a.key==this.options.key){a.preventDefault();try{this.CM.link.options.onclick()}catch(a){}}}});
